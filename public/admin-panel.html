<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel | Food Menu</title>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Montserrat', sans-serif;
    }
    
    body {
      background-color: #f5f5f5;
      color: #333;
    }
    
    .admin-header {
      background-color: #1a1a1a;
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .admin-logo {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .admin-logo img {
      height: 40px;
      width: auto;
    }
    
    .admin-title {
      font-size: 24px;
      font-weight: 700;
    }
    
    .admin-logout {
      background-color: transparent;
      color: #9AFF2B;
      border: 1px solid #9AFF2B;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
    }
    
    .admin-logout:hover {
      background-color: #9AFF2B;
      color: black;
    }
    
    .admin-container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 0 20px;
    }
    
    .admin-tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
      overflow-x: auto;
      white-space: nowrap;
      padding-bottom: 5px;
    }
    
    .admin-tab {
      padding: 12px 20px;
      cursor: pointer;
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      border-bottom: none;
      border-radius: 4px 4px 0 0;
      margin-right: 5px;
      transition: all 0.3s ease;
    }
    
    .admin-tab.active {
      background-color: #9AFF2B;
      color: black;
      font-weight: 600;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .admin-card {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      animation: fadeIn 0.3s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .admin-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .admin-card-title {
      font-size: 18px;
      font-weight: 700;
    }
    
    .admin-btn {
      background-color: #9AFF2B;
      color: black;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .admin-btn:hover {
      background-color: #8DF529;
      transform: translateY(-2px);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .admin-btn.secondary {
      background-color: #f0f0f0;
      color: #333;
    }
    
    .admin-btn.danger {
      background-color: #ff5757;
      color: white;
    }
    
    .admin-btn.danger:hover {
      background-color: #ff4242;
    }
    
    /* Table styles */
    .admin-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .admin-table th,
    .admin-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    
    .admin-table th {
      background-color: #f8f8f8;
      font-weight: 600;
    }
    
    .admin-table tr:hover {
      background-color: #f9f9f9;
    }
    
    .admin-table .actions {
      display: flex;
      gap: 10px;
    }
    
    /* Form styles */
    .admin-form {
      margin-top: 20px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .form-input, 
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 12px;
      border-radius: 4px;
      border: 1px solid #ddd;
      background-color: white;
      color: #333;
      font-size: 16px;
    }
    
    .form-input:focus, 
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: #9AFF2B;
      box-shadow: 0 0 5px rgba(154, 255, 43, 0.3);
    }
    
    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .form-price-input {
      position: relative;
    }
    
    .form-price-input::before {
      content: "₽";
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #777;
    }
    
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 15px;
      margin-top: 30px;
    }
    
    /* Order status */
    .status-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-new {
      background-color: rgba(79, 195, 247, 0.2);
      color: #0277bd;
    }
    
    .status-processing {
      background-color: rgba(255, 152, 0, 0.2);
      color: #e65100;
    }
    
    .status-ready {
      background-color: rgba(154, 255, 43, 0.2);
      color: #2e7d32;
    }
    
    .status-completed {
      background-color: rgba(139, 195, 74, 0.2);
      color: #558b2f;
    }
    
    .status-cancelled {
      background-color: rgba(255, 87, 87, 0.2);
      color: #d32f2f;
    }
    
    /* Product image preview */
    .image-upload-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .image-preview-container {
      width: 200px;
      height: 150px;
      border: 1px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background-color: #f8f8f8;
    }

    .image-preview {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .form-hint {
      font-size: 12px;
      color: #777;
      margin-top: 5px;
    }
    
    /* Modal window */
    .admin-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    .admin-modal.active {
      display: flex;
      opacity: 1;
      visibility: visible;
    }
    
    .modal-content {
      background-color: white;
      border-radius: 8px;
      padding: 25px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }
    
    .admin-modal.active .modal-content {
      transform: translateY(0);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 700;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #777;
    }
    
    /* Status messages */
    .status-message {
      padding: 12px 15px;
      margin-bottom: 20px;
      border-radius: 4px;
      display: none;
    }
    
    .status-message.success {
      background-color: rgba(154, 255, 43, 0.2);
      color: #3c7a00;
      border: 1px solid rgba(154, 255, 43, 0.5);
      display: block;
    }
    
    .status-message.error {
      background-color: rgba(255, 87, 87, 0.2);
      color: #aa2222;
      border: 1px solid rgba(255, 87, 87, 0.5);
      display: block;
    }
    
    /* Stats panel */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    
    .stat-value {
      font-size: 36px;
      font-weight: 700;
      margin: 10px 0;
      color: #9AFF2B;
    }
    
    .stat-label {
      color: #666;
      font-size: 14px;
    }
    
    /* Switch/Toggle */
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    
    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .slider {
      background-color: #9AFF2B;
    }
    
    input:focus + .slider {
      box-shadow: 0 0 1px #9AFF2B;
    }
    
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    
    /* Loading indicator */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      margin-right: 10px;
      vertical-align: middle;
      border: 3px solid rgba(154, 255, 43, 0.3);
      border-radius: 50%;
      border-top-color: #9AFF2B;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .admin-tabs {
        overflow-x: auto;
        white-space: nowrap;
        padding-bottom: 5px;
      }
      
      .admin-table {
        display: block;
        overflow-x: auto;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .admin-card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .form-actions {
        flex-direction: column;
      }
      
      .form-actions button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="admin-header">
    <div class="admin-logo">
      <img src="images/logo.png" alt="Logo">
      <div class="admin-title">Admin Panel</div>
    </div>
    <div style="display: flex; gap: 10px;">
      <a href="#" class="admin-logout" id="logoutBtn">Logout</a>
      <a href="index.html" class="admin-logout" id="viewSiteBtn">View Website</a>
    </div>
  </header>
  
  <div class="admin-container">
    <!-- Tabs -->
    <div class="admin-tabs">
      <div class="admin-tab active" data-tab="dashboard">Dashboard</div>
      <div class="admin-tab" data-tab="restaurants">Restaurants</div>
      <div class="admin-tab" data-tab="products">Products</div>
      <div class="admin-tab" data-tab="categories">Categories</div>
      <div class="admin-tab" data-tab="orders">Orders</div>
      <div class="admin-tab" data-tab="settings">Settings</div>
    </div>
    
    <!-- Dashboard Tab -->
    <div class="tab-content active" id="dashboard">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="restaurantCount">0</div>
          <div class="stat-label">Restaurants</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="productCount">0</div>
          <div class="stat-label">Products</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalOrders">0</div>
          <div class="stat-label">Orders</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalRevenue">0₽</div>
          <div class="stat-label">Revenue</div>
        </div>
      </div>
      
      <div class="admin-card">
        <div class="admin-card-header">
          <div class="admin-card-title">Recent Orders</div>
          <button class="admin-btn" id="viewAllOrdersBtn" data-tab="orders">All Orders</button>
        </div>
        <div id="recentOrdersList">
          <table class="admin-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Customer</th>
                <th>Restaurant</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody id="recentOrdersTable">
              <!-- Orders will be added via JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Restaurants Tab -->
    <div class="tab-content" id="restaurants">
      <div class="admin-card">
        <div class="admin-card-header">
          <div class="admin-card-title">Restaurants</div>
          <button class="admin-btn" id="addRestaurantBtn">Add Restaurant</button>
        </div>
        <div id="restaurantsStatusMessage" class="status-message"></div>
        <table class="admin-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Address</th>
              <th>Phone</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="restaurantsTable">
            <!-- Restaurants will be added via JavaScript -->
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Products Tab -->
    <div class="tab-content" id="products">
      <div class="admin-card">
        <div class="admin-card-header">
          <div class="admin-card-title">Products</div>
          <button class="admin-btn" id="addProductBtn">Add Product</button>
        </div>
        <div id="productsStatusMessage" class="status-message"></div>
        <table class="admin-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Category</th>
              <th>Price</th>
              <th>Restaurants</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="productsTable">
            <!-- Products will be added via JavaScript -->
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Categories Tab -->
    <div class="tab-content" id="categories">
      <div class="admin-card">
        <div class="admin-card-header">
          <div class="admin-card-title">Categories</div>
          <button class="admin-btn" id="addCategoryBtn">Add Category</button>
        </div>
        <div id="categoriesStatusMessage" class="status-message"></div>
        <table class="admin-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Slug</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="categoriesTable">
            <!-- Categories will be added via JavaScript -->
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Orders Tab -->
    <div class="tab-content" id="orders">
      <div class="admin-card">
        <div class="admin-card-header">
          <div class="admin-card-title">Orders</div>
          <div>
            <select id="orderFilterRestaurant" class="form-select" style="width: auto; display: inline-block; margin-right: 10px;">
              <option value="">All restaurants</option>
              <!-- Restaurants will be added via JavaScript -->
            </select>
            <select id="orderFilterStatus" class="form-select" style="width: auto; display: inline-block;">
              <option value="">All statuses</option>
              <option value="new">New</option>
              <option value="processing">Processing</option>
              <option value="ready">Ready for pickup</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
        </div>
        <div id="ordersStatusMessage" class="status-message"></div>
        <table class="admin-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Customer</th>
              <th>Restaurant</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="ordersTable">
            <!-- Orders will be added via JavaScript -->
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Settings Tab -->
    <div class="tab-content" id="settings">
      <div class="admin-card">
        <div class="admin-card-header">
          <div class="admin-card-title">Website Settings</div>
        </div>
        <div id="settingsStatusMessage" class="status-message"></div>
        <form id="settingsForm" class="admin-form">
          <div class="form-group">
            <label class="form-label">Website Name</label>
            <input type="text" id="siteTitle" name="siteTitle" class="form-input" value="FOOD MENU">
          </div>
          
          <div class="form-group">
            <label class="form-label">Contact Email</label>
            <input type="email" id="contactEmail" name="contactEmail" class="form-input" value="info@foodmenu.com">
          </div>
          
          <div class="form-group">
            <label class="form-label">Contact Phone</label>
            <input type="tel" id="contactPhone" name="contactPhone" class="form-input" value="+7 (123) 456-78-90">
          </div>
          
          <div class="form-group">
            <label class="form-label">Telegram Bot Settings</label>
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
              <label class="switch" style="margin-right: 10px;">
                <input type="checkbox" id="telegramBotEnabled" name="telegramBotEnabled">
                <span class="slider"></span>
              </label>
              <span>Enable order notifications</span>
            </div>
            
            <input type="text" id="telegramBotToken" name="telegramBotToken" class="form-input" placeholder="Telegram Bot Token" style="margin-bottom: 10px;">
            <input type="text" id="telegramChatId" name="telegramChatId" class="form-input" placeholder="Chat ID for notifications">
            <p class="form-hint">To receive notifications, you need to create a Telegram bot (@BotFather) and get a chat ID. <a href="https://core.telegram.org/bots#how-do-i-create-a-bot" target="_blank">Learn how</a></p>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="admin-btn">Save Settings</button>
          </div>
        </form>
      </div>
      
      <div class="admin-card">
        <div class="admin-card-header">
          <div class="admin-card-title">Administrator Settings</div>
        </div>
        <div id="adminStatusMessage" class="status-message"></div>
        <form id="adminForm" class="admin-form">
          <div class="form-group">
            <label class="form-label">Username</label>
            <input type="text" id="adminUsername" name="adminUsername" class="form-input">
          </div>
          
          <div class="form-group">
            <label class="form-label">New Password</label>
            <input type="password" id="adminPassword" name="adminPassword" class="form-input">
          </div>
          
          <div class="form-group">
            <label class="form-label">Confirm Password</label>
            <input type="password" id="adminPasswordConfirm" name="adminPasswordConfirm" class="form-input">
          </div>
          
          <div class="form-actions">
            <button type="submit" class="admin-btn">Save Admin Details</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Restaurant Modal -->
  <div class="admin-modal" id="restaurantModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="restaurantModalTitle">Add Restaurant</h3>
        <button type="button" class="modal-close" id="closeRestaurantModal">&times;</button>
      </div>
      <form id="restaurantForm" class="admin-form">
        <input type="hidden" id="restaurantId" name="restaurantId">
        
        <div class="form-group">
          <label class="form-label">Restaurant Name</label>
          <input type="text" id="restaurantName" name="name" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Address</label>
          <input type="text" id="restaurantAddress" name="address" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Working Hours</label>
          <input type="text" id="restaurantHours" name="hours" class="form-input" 
                 placeholder="Mon-Fri: 10:00 - 22:00, Sat-Sun: 11:00 - 23:00" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Phone</label>
          <input type="text" id="restaurantPhone" name="phone" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" id="restaurantEmail" name="email" class="form-input" required>
        </div>
        <div class="form-group">
        <label class="form-label">Restaurant Icon</label>
        <div class="image-upload-container">
          <input type="file" id="restaurantIconFile" name="iconFile" accept="image/*" class="form-input">
          <div class="image-preview-container">
            <img id="restaurantIconPreview" class="image-preview" src="images/restaurant-placeholder.png" alt="Preview">
          </div>
        </div>
        <input type="hidden" id="restaurantIcon" name="icon" value="">
        <p class="form-hint">Select an image icon for the restaurant. Recommended size: 200x200 pixels.</p>
      </div>

      <div class="form-group">
        <label class="form-label">Delivery Time (minutes)</label>
        <input type="number" id="restaurantDeliveryTime" name="deliveryTime" class="form-input" value="30" min="1" max="120">
      </div>
        
        <div class="form-group">
          <label class="form-label">Status</label>
          <label class="switch">
            <input type="checkbox" id="restaurantIsActive" name="isActive" checked>
            <span class="slider"></span>
          </label>
          <span style="margin-left: 10px;">Active</span>
        </div>
        
        <div class="form-actions">
          <button type="button" class="admin-btn secondary" id="cancelRestaurantBtn">Cancel</button>
          <button type="submit" class="admin-btn">Save</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Product Modal -->
  <div class="admin-modal" id="productModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="productModalTitle">Add Product</h3>
        <button type="button" class="modal-close" id="closeProductModal">&times;</button>
      </div>
      <form id="productForm" class="admin-form">
        <input type="hidden" id="productId" name="productId">
        
        <div class="form-group">
          <label class="form-label">Product Name</label>
          <input type="text" id="productName" name="name" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Category</label>
          <select id="productCategory" name="category" class="form-select" required>
            <option value="">Select category</option>
            <!-- Categories will be added via JavaScript -->
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Price, ₽</label>
          <input type="number" id="productPrice" name="price" class="form-input" required min="0">
        </div>
        
        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea id="productDescription" name="description" class="form-textarea" required></textarea>
        </div>
        
        <div class="form-group">
          <label class="form-label">Product Image</label>
          <div class="image-upload-container">
            <input type="file" id="productImageFile" name="imageFile" accept="image/*" class="form-input">
            <div class="image-preview-container">
              <img id="productImagePreview" class="image-preview" src="images/default.jpg" alt="Preview">
            </div>
          </div>
          <input type="hidden" id="productImage" name="image" value="default.jpg">
          <p class="form-hint">Select an image in JPG, PNG, or GIF format. Recommended size: 400x300 pixels.</p>
        </div>
        
        <div class="form-group">
          <label class="form-label">Restaurants</label>
          <div id="productRestaurantsCheckboxes" style="margin-top: 10px;">
            <!-- Restaurants will be added via JavaScript -->
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Status</label>
          <label class="switch">
            <input type="checkbox" id="productIsActive" name="isActive" checked>
            <span class="slider"></span>
          </label>
          <span style="margin-left: 10px;">Active</span>
        </div>
        
        <div class="form-actions">
          <button type="button" class="admin-btn secondary" id="cancelProductBtn">Cancel</button>
          <button type="submit" class="admin-btn">Save</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Category Modal -->
  <div class="admin-modal" id="categoryModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="categoryModalTitle">Add Category</h3>
        <button type="button" class="modal-close" id="closeCategoryModal">&times;</button>
      </div>
      <form id="categoryForm" class="admin-form">
        <input type="hidden" id="categoryId" name="categoryId">
        
        <div class="form-group">
          <label class="form-label">Category Name</label>
          <input type="text" id="categoryName" name="name" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Slug (for URL)</label>
          <input type="text" id="categorySlug" name="slug" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Status</label>
          <label class="switch">
            <input type="checkbox" id="categoryIsActive" name="isActive" checked>
            <span class="slider"></span>
          </label>
          <span style="margin-left: 10px;">Active</span>
        </div>
        
        <div class="form-actions">
          <button type="button" class="admin-btn secondary" id="cancelCategoryBtn">Cancel</button>
          <button type="submit" class="admin-btn">Save</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Order Modal -->
  <div class="admin-modal" id="orderModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="orderModalTitle">View Order</h3>
        <button type="button" class="modal-close" id="closeOrderModal">&times;</button>
      </div>
      
      <div id="orderDetails">
        <div class="form-group">
          <label class="form-label">Order Number</label>
          <div id="orderNumber" style="font-size: 18px; font-weight: bold;"></div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Status</label>
          <select id="orderStatus" class="form-select">
            <option value="new">New</option>
            <option value="processing">Processing</option>
            <option value="ready">Ready for pickup</option>
            <option value="completed">Completed</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Customer</label>
          <div id="orderCustomer"></div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Phone</label>
          <div id="orderPhone"></div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Restaurant</label>
          <div id="orderRestaurant"></div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Pickup Time</label>
          <div id="orderPickupTime"></div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Date/Time</label>
          <div id="orderDateTime"></div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Order Items</label>
          <table class="admin-table">
            <thead>
              <tr>
                <th>Product</th>
                <th>Price</th>
                <th>Qty</th>
                <th>Amount</th>
              </tr>
            </thead>
            <tbody id="orderItems"></tbody>
          </table>
        </div>
        
        <div class="form-group">
          <label class="form-label">Total</label>
          <div id="orderTotal" style="font-size: 18px; font-weight: bold;"></div>
        </div>
        
        <div class="form-actions">
          <button type="button" class="admin-btn secondary" id="closeOrderBtn">Close</button>
          <button type="button" class="admin-btn" id="saveOrderStatusBtn">Save Status</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Scripts -->
  <script src="db.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Admin panel loaded');
      
      // Authentication check
      if (!sessionStorage.getItem('adminSession')) {
        console.log('Not authenticated, redirecting to login page');
        window.location.href = 'login.html';
        return;
      }
      
      // Variables for current data
      let currentRestaurantId = null;
      let currentProductId = null;
      let currentCategoryId = null;
      let currentOrderId = null;
      
      // Admin panel logout
      document.getElementById('logoutBtn').addEventListener('click', function(e) {
        e.preventDefault();
        console.log('Logging out of admin panel');
        
        // Try to use the logout function from db.js if available
        try {
          if (window.db && window.db.auth && typeof window.db.auth.logout === 'function') {
            window.db.auth.logout();
          }
        } catch (error) {
          console.error('Error during logout:', error);
        }
        
        // Remove session in any case
        sessionStorage.removeItem('adminSession');
        
        // Redirect to login page
        window.location.href = 'login.html';
      });
      
      // Initialize tabs
      function initTabs() {
        const tabs = document.querySelectorAll('.admin-tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabs.forEach(tab => {
          tab.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');
            
            // Remove active class from all tabs and content
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            this.classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            // Load data for selected tab
            loadTabData(tabId);
          });
        });
        
        // "All Orders" button
        document.getElementById('viewAllOrdersBtn').addEventListener('click', function() {
          const tabId = this.getAttribute('data-tab');
          
          // Remove active class from all tabs and content
          tabs.forEach(t => t.classList.remove('active'));
          tabContents.forEach(content => content.classList.remove('active'));
          
          // Add active class to selected tab and content
          document.querySelector(`.admin-tab[data-tab="${tabId}"]`).classList.add('active');
          document.getElementById(tabId).classList.add('active');
          
          // Load data for selected tab
          loadTabData(tabId);
        });
      }
      
      // Load data for selected tab
      function loadTabData(tabId) {
        console.log('Loading data for tab:', tabId);
        switch(tabId) {
          case 'dashboard':
            loadDashboardData();
            break;
          case 'restaurants':
            loadRestaurants();
            break;
          case 'products':
            loadProducts();
            break;
          case 'categories':
            loadCategories();
            break;
          case 'orders':
            loadOrders();
            break;
          case 'settings':
            loadSettings();
            break;
        }
      }
      
      // RESTAURANT FUNCTIONS
      
      // Initialize restaurant form
      function initRestaurantForm() {
        console.log('Initializing restaurant form');
        const addRestaurantBtn = document.getElementById('addRestaurantBtn');
        const restaurantModal = document.getElementById('restaurantModal');
        const closeRestaurantModal = document.getElementById('closeRestaurantModal');
        const cancelRestaurantBtn = document.getElementById('cancelRestaurantBtn');
        const restaurantForm = document.getElementById('restaurantForm');

        const restaurantIconFile = document.getElementById('restaurantIconFile');
        const restaurantIconPreview = document.getElementById('restaurantIconPreview');
        
        if (restaurantIconFile) {
          restaurantIconFile.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = function(event) {
                restaurantIconPreview.src = event.target.result;
                document.getElementById('restaurantIcon').value = event.target.result;
              };
              reader.readAsDataURL(file);
            }
          });
        }
        
        // Open modal for adding restaurant
        addRestaurantBtn.addEventListener('click', function() {
          console.log('Opening restaurant modal');
          currentRestaurantId = null;
          document.getElementById('restaurantModalTitle').textContent = 'Add Restaurant';
          restaurantForm.reset();
          restaurantModal.classList.add('active');
        });
        
        // Close modal
        closeRestaurantModal.addEventListener('click', function() {
          restaurantModal.classList.remove('active');
        });
        
        cancelRestaurantBtn.addEventListener('click', function() {
          restaurantModal.classList.remove('active');
        });
        
        // Form submission handler for adding/editing restaurant
        restaurantForm.addEventListener('submit', function(e) {
          e.preventDefault();
          console.log('Submitting restaurant form');
          
          const restaurantData = {
            name: document.getElementById('restaurantName').value,
            address: document.getElementById('restaurantAddress').value,
            hours: document.getElementById('restaurantHours').value,
            phone: document.getElementById('restaurantPhone').value,
            email: document.getElementById('restaurantEmail').value,
            isActive: document.getElementById('restaurantIsActive').checked,
            // Новые поля
            icon: document.getElementById('restaurantIcon').value,
            deliveryTime: document.getElementById('restaurantDeliveryTime').value
          };
          
          try {
            if (currentRestaurantId) {
              // Edit restaurant
              db.restaurants.update(currentRestaurantId, restaurantData);
              showStatusMessage('restaurantsStatusMessage', `Restaurant "${restaurantData.name}" successfully updated`, 'success');
            } else {
              // Create ID for new restaurant (if not in DB)
              const slug = restaurantData.name.toLowerCase()
                .replace(/[^\w\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-');
              restaurantData.id = slug;
              
              // Add restaurant
              db.restaurants.add(restaurantData);
              showStatusMessage('restaurantsStatusMessage', `Restaurant "${restaurantData.name}" successfully added`, 'success');
            }
            
            // Close modal and update restaurant list
            restaurantModal.classList.remove('active');
            loadRestaurants();
            
            // Update dashboard statistics
            loadDashboardData();
          } catch (error) {
            console.error('Error saving restaurant:', error);
            showStatusMessage('restaurantsStatusMessage', `Error: ${error.message}`, 'error');
          }
        });
      }
      
      // Edit restaurant
      function editRestaurant(restaurantId) {
        console.log('Editing restaurant:', restaurantId);
        const restaurant = db.restaurants.getById(restaurantId);
        if (!restaurant) return;
        
        currentRestaurantId = restaurantId;
        document.getElementById('restaurantModalTitle').textContent = 'Edit Restaurant';
        
        document.getElementById('restaurantId').value = restaurant.id;
        document.getElementById('restaurantName').value = restaurant.name;
        document.getElementById('restaurantAddress').value = restaurant.address;
        document.getElementById('restaurantHours').value = restaurant.hours;
        document.getElementById('restaurantPhone').value = restaurant.phone;
        document.getElementById('restaurantEmail').value = restaurant.email;
        document.getElementById('restaurantIsActive').checked = restaurant.isActive !== false;
        document.getElementById('restaurantIconPreview').src = restaurant.icon || 'images/restaurant-placeholder.png';
        document.getElementById('restaurantIcon').value = restaurant.icon || '';
        document.getElementById('restaurantDeliveryTime').value = restaurant.deliveryTime || '30';
        document.getElementById('restaurantModal').classList.add('active');
      }
      
      // Delete restaurant
      function deleteRestaurant(restaurantId) {
        console.log('Deleting restaurant:', restaurantId);
        const restaurant = db.restaurants.getById(restaurantId);
        if (!restaurant) return;
        
        // Check if there are orders linked to the restaurant
        const hasOrders = db.orders.getAll().some(order => order.restaurantId === restaurantId);
        
        if (hasOrders) {
          showStatusMessage('restaurantsStatusMessage', `Cannot delete restaurant "${restaurant.name}": it has associated orders`, 'error');
          return;
        }
        
        // Confirm deletion
        if (confirm(`Are you sure you want to delete restaurant "${restaurant.name}"?`)) {
          db.restaurants.delete(restaurantId);
          showStatusMessage('restaurantsStatusMessage', `Restaurant "${restaurant.name}" successfully deleted`, 'success');
          
          // Update restaurant list and statistics
          loadRestaurants();
          loadDashboardData();
        }
      }
      
      // Toggle restaurant status
      function toggleRestaurantStatus(restaurantId, isActive) {
        console.log('Toggling restaurant status:', restaurantId, isActive);
        try {
          const restaurant = db.restaurants.getById(restaurantId);
          if (!restaurant) return;
          
          db.restaurants.update(restaurantId, { isActive });
          showStatusMessage('restaurantsStatusMessage', `Restaurant "${restaurant.name}" status changed to "${isActive ? 'active' : 'inactive'}"`, 'success');
          
          // Reload restaurants
          loadRestaurants();
        } catch (error) {
          console.error('Error changing restaurant status:', error);
          showStatusMessage('restaurantsStatusMessage', `Error: ${error.message}`, 'error');
        }
      }
      
      // Load restaurants
      function loadRestaurants() {
        console.log('Loading restaurants');
        try {
          if (window.db && window.db.restaurants && typeof window.db.restaurants.getAll === 'function') {
            const restaurants = db.restaurants.getAll();
            const restaurantsTable = document.getElementById('restaurantsTable');
            restaurantsTable.innerHTML = '';
            
            if (restaurants.length === 0) {
              restaurantsTable.innerHTML = '<tr><td colspan="6" style="text-align: center;">No restaurants found</td></tr>';
              return;
            }
            
            restaurants.forEach(restaurant => {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${restaurant.id}</td>
                <td>${restaurant.name}</td>
                <td>${restaurant.address}</td>
                <td>${restaurant.phone}</td>
                <td>
                  <label class="switch">
                    <input type="checkbox" data-restaurant-id="${restaurant.id}" data-action="toggle-restaurant" ${restaurant.isActive ? 'checked' : ''}>
                    <span class="slider"></span>
                  </label>
                </td>
                <td class="actions">
                  <button class="admin-btn" data-restaurant-id="${restaurant.id}" data-action="edit-restaurant">Edit</button>
                  <button class="admin-btn danger" data-restaurant-id="${restaurant.id}" data-action="delete-restaurant">Delete</button>
                </td>
              `;
              
              restaurantsTable.appendChild(row);
            });
            
            // Add event handlers
            document.querySelectorAll('[data-action="edit-restaurant"]').forEach(btn => {
              btn.addEventListener('click', function() {
                const restaurantId = this.getAttribute('data-restaurant-id');
                editRestaurant(restaurantId);
              });
            });
            
            document.querySelectorAll('[data-action="delete-restaurant"]').forEach(btn => {
              btn.addEventListener('click', function() {
                const restaurantId = this.getAttribute('data-restaurant-id');
                deleteRestaurant(restaurantId);
              });
            });
            
            document.querySelectorAll('[data-action="toggle-restaurant"]').forEach(checkbox => {
              checkbox.addEventListener('change', function() {
                const restaurantId = this.getAttribute('data-restaurant-id');
                const isActive = this.checked;
                toggleRestaurantStatus(restaurantId, isActive);
              });
            });
          } else {
            console.warn('db.restaurants.getAll not found');
            document.getElementById('restaurantsTable').innerHTML = '<tr><td colspan="6" style="text-align: center;">Data unavailable</td></tr>';
          }
        } catch (error) {
          console.error('Error loading restaurants:', error);
          document.getElementById('restaurantsTable').innerHTML = `<tr><td colspan="6" style="text-align: center;">Error: ${error.message}</td></tr>`;
        }
      }
      
      // PRODUCT FUNCTIONS
      
      // Initialize product form
      function initProductForm() {
        console.log('Initializing product form');
        const addProductBtn = document.getElementById('addProductBtn');
        const productModal = document.getElementById('productModal');
        const closeProductModal = document.getElementById('closeProductModal');
        const cancelProductBtn = document.getElementById('cancelProductBtn');
        const productForm = document.getElementById('productForm');
        const productImageFile = document.getElementById('productImageFile');
        const productImagePreview = document.getElementById('productImagePreview');
        
        // Load categories for the dropdown
        function loadCategoriesForSelect() {
          const categorySelect = document.getElementById('productCategory');
          const categories = db.categories.getActive();
          
          // Clear existing options except the first one
          while (categorySelect.options.length > 1) {
            categorySelect.remove(1);
          }
          
          // Add categories to dropdown
          categories.forEach(category => {
            if (category.id !== 'all') { // Skip the "All" category
              const option = document.createElement('option');
              option.value = category.id;
              option.textContent = category.name;
              categorySelect.appendChild(option);
            }
          });
        }
        
        // Load restaurants for checkboxes
        function loadRestaurantsForCheckboxes() {
          const restaurantsContainer = document.getElementById('productRestaurantsCheckboxes');
          const restaurants = db.restaurants.getActive();
          
          restaurantsContainer.innerHTML = '';
          
          restaurants.forEach(restaurant => {
            const checkboxDiv = document.createElement('div');
            checkboxDiv.innerHTML = `
              <label style="display: flex; align-items: center; margin-bottom: 10px;">
                <input type="checkbox" name="restaurant-${restaurant.id}" value="${restaurant.id}" style="margin-right: 10px;">
                ${restaurant.name}
              </label>
            `;
            restaurantsContainer.appendChild(checkboxDiv);
          });
        }
        
        // Image file change handler
        if (productImageFile) {
          productImageFile.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = function(event) {
                productImagePreview.src = event.target.result;
                document.getElementById('productImage').value = event.target.result;
              };
              reader.readAsDataURL(file);
            }
          });
        }
        
        // Open modal for adding product
        if (addProductBtn) {
          addProductBtn.addEventListener('click', function() {
            console.log('Opening product modal');
            currentProductId = null;
            document.getElementById('productModalTitle').textContent = 'Add Product';
            productForm.reset();
            productImagePreview.src = 'images/default.jpg';
            document.getElementById('productImage').value = 'default.jpg';
            
            loadCategoriesForSelect();
            loadRestaurantsForCheckboxes();
            
            productModal.classList.add('active');
          });
        } else {
          console.error('Add Product button not found');
        }
        
        // Close modal
        if (closeProductModal) {
          closeProductModal.addEventListener('click', function() {
            productModal.classList.remove('active');
          });
        }
        
        if (cancelProductBtn) {
          cancelProductBtn.addEventListener('click', function() {
            productModal.classList.remove('active');
          });
        }
        
        // Form submission handler for adding/editing product
        if (productForm) {
          productForm.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('Submitting product form');
            
            // Get selected restaurants
            const restaurantIds = [];
            document.querySelectorAll('#productRestaurantsCheckboxes input[type="checkbox"]:checked').forEach(checkbox => {
              restaurantIds.push(checkbox.value);
            });
            
            if (restaurantIds.length === 0) {
              alert('Please select at least one restaurant');
              return;
            }
            
            const productData = {
              name: document.getElementById('productName').value,
              category: document.getElementById('productCategory').value,
              price: parseFloat(document.getElementById('productPrice').value),
              description: document.getElementById('productDescription').value,
              image: document.getElementById('productImage').value,
              restaurantIds: restaurantIds,
              isActive: document.getElementById('productIsActive').checked
            };
            
            try {
              if (currentProductId) {
                // Edit product
                db.products.update(currentProductId, productData);
                showStatusMessage('productsStatusMessage', `Product "${productData.name}" successfully updated`, 'success');
              } else {
                // Create ID for new product
                const slug = productData.name.toLowerCase()
                  .replace(/[^\w\s-]/g, '')
                  .replace(/\s+/g, '-')
                  .replace(/-+/g, '-');
                productData.id = slug + '-' + Date.now().toString().slice(-4);
                
                // Add product
                db.products.add(productData);
                showStatusMessage('productsStatusMessage', `Product "${productData.name}" successfully added`, 'success');
              }
              
              // Close modal and update product list
              productModal.classList.remove('active');
              loadProducts();
              
              // Update dashboard statistics
              loadDashboardData();
            } catch (error) {
              console.error('Error saving product:', error);
              showStatusMessage('productsStatusMessage', `Error: ${error.message}`, 'error');
            }
          });
        } else {
          console.error('Product form not found');
        }
      }

      // Edit product
      function editProduct(productId) {
        console.log('Editing product:', productId);
        const product = db.products.getById(productId);
        if (!product) {
          console.error('Product not found:', productId);
          return;
        }
      
        currentProductId = productId;
        document.getElementById('productModalTitle').textContent = 'Edit Product';
      
        // Load categories for select
        const categorySelect = document.getElementById('productCategory');
        const categories = db.categories.getActive();
      
        // Clear existing options except the first one
        while (categorySelect.options.length > 1) {
          categorySelect.remove(1);
        }
      
        // Add categories to dropdown
        categories.forEach(category => {
          if (category.id !== 'all') { // Skip the "All" category
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            categorySelect.appendChild(option);
          }
        });
      
        // Load restaurants for checkboxes
        const restaurantsContainer = document.getElementById('productRestaurantsCheckboxes');
        const restaurants = db.restaurants.getActive();
      
        restaurantsContainer.innerHTML = '';
      
        restaurants.forEach(restaurant => {
          const checkboxDiv = document.createElement('div');
          checkboxDiv.innerHTML = `
            <label style="display: flex; align-items: center; margin-bottom: 10px;">
              <input type="checkbox" name="restaurant-${restaurant.id}" value="${restaurant.id}" style="margin-right: 10px;" ${product.restaurantIds && product.restaurantIds.includes(restaurant.id) ? 'checked' : ''}>
              ${restaurant.name}
            </label>
          `;
          restaurantsContainer.appendChild(checkboxDiv);
        });
      
        // Set form values
        document.getElementById('productId').value = product.id;
        document.getElementById('productName').value = product.name;
        document.getElementById('productCategory').value = product.category;
        document.getElementById('productPrice').value = product.price;
        document.getElementById('productDescription').value = product.description;
        document.getElementById('productIsActive').checked = product.isActive !== false;
      
        // Set image preview
        const imageSrc = product.image && product.image.startsWith('data:image')
          ? product.image
          : `images/${product.image || 'default.jpg'}`;
        document.getElementById('productImagePreview').src = imageSrc;
        document.getElementById('productImage').value = product.image || 'default.jpg';
      
        // Open modal
        document.getElementById('productModal').classList.add('active');
      }
      // Delete product
      // Delete product
      function deleteProduct(productId) {
        console.log('Attempting to delete product:', productId);
        
        // Получаем продукт по ID
        const product = db.products.getById(productId);
        if (!product) {
          console.error('Product not found for deletion:', productId);
          showStatusMessage('productsStatusMessage', 'Error: Product not found', 'error');
          return;
        }
        
        console.log('Found product to delete:', product.name);
        
        // Если хотите, можно пропустить проверку на наличие товара в заказах
        // Как вариант, это можно сделать опциональной проверкой
        // Главное чтобы работало удаление
        
        // Запрашиваем подтверждение удаления
        if (confirm(`Are you sure you want to delete product "${product.name}"?`)) {
          try {
            console.log('Attempting to delete from database');
            
            // Попытка удалить продукт напрямую из localStorage
            // Это обход обычного API, если стандартный метод не работает
            const allProducts = JSON.parse(localStorage.getItem('products') || '[]');
            const filteredProducts = allProducts.filter(p => p.id !== productId);
            
            if (allProducts.length === filteredProducts.length) {
              console.error('Product not found in localStorage array');
              showStatusMessage('productsStatusMessage', `Error: Product "${product.name}" not found in database`, 'error');
              return;
            }
            
            // Сохраняем обновленный список продуктов
            localStorage.setItem('products', JSON.stringify(filteredProducts));
            console.log('Product deleted via direct localStorage manipulation');
            
            // Показываем сообщение об успехе
            showStatusMessage('productsStatusMessage', `Product "${product.name}" successfully deleted`, 'success');
            
            // Обновляем список продуктов и статистику
            loadProducts();
            loadDashboardData();
          } catch (error) {
            // Обрабатываем ошибки, если что-то пошло не так
            console.error('Error in product deletion:', error);
            showStatusMessage('productsStatusMessage', `Error deleting product: ${error.message}`, 'error');
          }
        } else {
          console.log('Product deletion cancelled by user');
        }
      }
      
      // Load products
      // Load products
      function loadProducts() {
        console.log('Loading products');
        try {
          const products = db.products.getAll();
          const productsTable = document.getElementById('productsTable');
          productsTable.innerHTML = '';
      
          if (products.length === 0) {
            productsTable.innerHTML = '<tr><td colspan="6" style="text-align: center;">No products found</td></tr>';
            return;
          }
      
          products.forEach(product => {
            // Get category and restaurant names
            const category = db.categories.getById(product.category) || { name: 'Unknown' };
      
            let restaurantNames = '';
            if (product.restaurantIds && product.restaurantIds.length > 0) {
              restaurantNames = product.restaurantIds.map(id => {
                const restaurant = db.restaurants.getById(id);
                return restaurant ? restaurant.name : 'Unknown';
              }).join(', ');
            }
      
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${product.id}</td>
              <td>${product.name}</td>
              <td>${category.name}</td>
              <td>${product.price}₽</td>
              <td>${restaurantNames}</td>
              <td class="actions">
                <button class="admin-btn" data-product-id="${product.id}" data-action="edit-product">Edit</button>
                <button class="admin-btn danger" data-product-id="${product.id}" data-action="delete-product">Delete</button>
              </td>
            `;
      
            productsTable.appendChild(row);
          });
      
          // Add event handlers
          document.querySelectorAll('[data-action="edit-product"]').forEach(btn => {
            btn.addEventListener('click', function() {
              const productId = this.getAttribute('data-product-id');
              editProduct(productId);
            });
          });
      
          document.querySelectorAll('[data-action="delete-product"]').forEach(btn => {
            btn.addEventListener('click', function() {
              const productId = this.getAttribute('data-product-id');
              deleteProduct(productId);
            });
          });
        } catch (error) {
          console.error('Error loading products:', error);
          document.getElementById('productsTable').innerHTML = `<tr><td colspan="6" style="text-align: center;">Error: ${error.message}</td></tr>`;
        }
      }
      
      // CATEGORY FUNCTIONS
      
      // Initialize category form
      function initCategoryForm() {
        console.log('Initializing category form');
        const addCategoryBtn = document.getElementById('addCategoryBtn');
        const categoryModal = document.getElementById('categoryModal');
        const closeCategoryModal = document.getElementById('closeCategoryModal');
        const cancelCategoryBtn = document.getElementById('cancelCategoryBtn');
        const categoryForm = document.getElementById('categoryForm');
        const categoryName = document.getElementById('categoryName');
        const categorySlug = document.getElementById('categorySlug');
        
        // Auto-generate slug from name
        categoryName.addEventListener('input', function() {
          const slug = this.value.toLowerCase()
            .replace(/[^\w\s-]/g, '')
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-');
          
          categorySlug.value = slug;
        });
        
        // Open modal for adding category
        addCategoryBtn.addEventListener('click', function() {
          console.log('Opening category modal');
          currentCategoryId = null;
          document.getElementById('categoryModalTitle').textContent = 'Add Category';
          categoryForm.reset();
          categoryModal.classList.add('active');
        });
        
        // Close modal
        closeCategoryModal.addEventListener('click', function() {
          categoryModal.classList.remove('active');
        });
        
        cancelCategoryBtn.addEventListener('click', function() {
          categoryModal.classList.remove('active');
        });
        
        // Form submission handler for adding/editing category
        categoryForm.addEventListener('submit', function(e) {
          e.preventDefault();
          console.log('Submitting category form');
          
          const categoryData = {
            name: categoryName.value,
            slug: categorySlug.value,
            isActive: document.getElementById('categoryIsActive').checked
          };
          
          try {
            // Check if slug is already in use
            const categories = db.categories.getAll();
            const slugExists = categories.some(cat => 
              cat.slug === categoryData.slug && (!currentCategoryId || cat.id !== currentCategoryId)
            );
            
            if (slugExists) {
              throw new Error('Slug already exists. Please choose a different one.');
            }
            
            if (currentCategoryId) {
              // Edit category
              db.categories.update(currentCategoryId, categoryData);
              showStatusMessage('categoriesStatusMessage', `Category "${categoryData.name}" successfully updated`, 'success');
            } else {
              // Create ID for new category
              categoryData.id = categoryData.slug;
              
              // Add category
              db.categories.add(categoryData);
              showStatusMessage('categoriesStatusMessage', `Category "${categoryData.name}" successfully added`, 'success');
            }
            
            // Close modal and update category list
            categoryModal.classList.remove('active');
            loadCategories();
          } catch (error) {
            console.error('Error saving category:', error);
            showStatusMessage('categoriesStatusMessage', `Error: ${error.message}`, 'error');
          }
        });
      }
      
      // Edit category
      function editCategory(categoryId) {
        console.log('Editing category:', categoryId);
        const category = db.categories.getById(categoryId);
        if (!category) return;
        
        // Skip "all" category
        if (category.id === 'all') {
          showStatusMessage('categoriesStatusMessage', 'The "All" category cannot be edited', 'error');
          return;
        }
        
        currentCategoryId = categoryId;
        document.getElementById('categoryModalTitle').textContent = 'Edit Category';
        
        document.getElementById('categoryId').value = category.id;
        document.getElementById('categoryName').value = category.name;
        document.getElementById('categorySlug').value = category.slug;
        document.getElementById('categoryIsActive').checked = category.isActive !== false;
        
        document.getElementById('categoryModal').classList.add('active');
      }
      
      // Delete category
      function deleteCategory(categoryId) {
        console.log('Deleting category:', categoryId);
        const category = db.categories.getById(categoryId);
        if (!category) return;
        
        // Skip "all" category
        if (category.id === 'all') {
          showStatusMessage('categoriesStatusMessage', 'The "All" category cannot be deleted', 'error');
          return;
        }
        
        // Check if there are products in this category
        const hasProducts = db.products.getAll().some(product => product.category === categoryId);
        
        if (hasProducts) {
          showStatusMessage('categoriesStatusMessage', `Cannot delete category "${category.name}": it contains products`, 'error');
          return;
        }
        
        // Confirm deletion
        if (confirm(`Are you sure you want to delete category "${category.name}"?`)) {
          db.categories.delete(categoryId);
          showStatusMessage('categoriesStatusMessage', `Category "${category.name}" successfully deleted`, 'success');
          
          // Update category list
          loadCategories();
        }
      }
      
      // Toggle category status
      function toggleCategoryStatus(categoryId, isActive) {
        console.log('Toggling category status:', categoryId, isActive);
        try {
          const category = db.categories.getById(categoryId);
          if (!category) return;
          
          // Skip "all" category
          if (category.id === 'all') {
            showStatusMessage('categoriesStatusMessage', 'The "All" category status cannot be changed', 'error');
            return;
          }
          
          db.categories.update(categoryId, { isActive });
          showStatusMessage('categoriesStatusMessage', `Category "${category.name}" status changed to "${isActive ? 'active' : 'inactive'}"`, 'success');
        } catch (error) {
          console.error('Error changing category status:', error);
          showStatusMessage('categoriesStatusMessage', `Error: ${error.message}`, 'error');
        }
      }
      
      // Load categories
      function loadCategories() {
        console.log('Loading categories');
        try {
          const categories = db.categories.getAll();
          const categoriesTable = document.getElementById('categoriesTable');
          categoriesTable.innerHTML = '';
          
          if (categories.length === 0) {
            categoriesTable.innerHTML = '<tr><td colspan="5" style="text-align: center;">No categories found</td></tr>';
            return;
          }
          
          categories.forEach(category => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${category.id}</td>
              <td>${category.name}</td>
              <td>${category.slug}</td>
              <td>
                <label class="switch">
                  <input type="checkbox" data-category-id="${category.id}" data-action="toggle-category" ${category.isActive ? 'checked' : ''} ${category.id === 'all' ? 'disabled' : ''}>
                  <span class="slider"></span>
                </label>
              </td>
              <td class="actions">
                <button class="admin-btn" data-category-id="${category.id}" data-action="edit-category" ${category.id === 'all' ? 'disabled' : ''}>Edit</button>
                <button class="admin-btn danger" data-category-id="${category.id}" data-action="delete-category" ${category.id === 'all' ? 'disabled' : ''}>Delete</button>
              </td>
            `;
            
            categoriesTable.appendChild(row);
          });
          
          // Add event handlers
          document.querySelectorAll('[data-action="edit-category"]').forEach(btn => {
            if (!btn.disabled) {
              btn.addEventListener('click', function() {
                const categoryId = this.getAttribute('data-category-id');
                editCategory(categoryId);
              });
            }
          });
          
          document.querySelectorAll('[data-action="delete-category"]').forEach(btn => {
            if (!btn.disabled) {
              btn.addEventListener('click', function() {
                const categoryId = this.getAttribute('data-category-id');
                deleteCategory(categoryId);
              });
            }
          });
          
          document.querySelectorAll('[data-action="toggle-category"]').forEach(checkbox => {
            if (!checkbox.disabled) {
              checkbox.addEventListener('change', function() {
                const categoryId = this.getAttribute('data-category-id');
                const isActive = this.checked;
                toggleCategoryStatus(categoryId, isActive);
              });
            }
          });
        } catch (error) {
          console.error('Error loading categories:', error);
          document.getElementById('categoriesTable').innerHTML = `<tr><td colspan="5" style="text-align: center;">Error: ${error.message}</td></tr>`;
        }
      }
      
      // ORDER FUNCTIONS
      
      // Initialize order filters
      function initOrderFilters() {
        console.log('Initializing order filters');
        const restaurantFilter = document.getElementById('orderFilterRestaurant');
        const statusFilter = document.getElementById('orderFilterStatus');
        
        // Fill restaurant filter with active restaurants
        const restaurants = db.restaurants.getActive();
        restaurants.forEach(restaurant => {
          const option = document.createElement('option');
          option.value = restaurant.id;
          option.textContent = restaurant.name;
          restaurantFilter.appendChild(option);
        });
        
        // Add event listeners to filters
        restaurantFilter.addEventListener('change', loadOrders);
        statusFilter.addEventListener('change', loadOrders);
      }
      
      // View order details
      function viewOrder(orderId) {
        console.log('Viewing order:', orderId);
        const order = db.orders.getById(orderId);
        if (!order) return;
        
        currentOrderId = orderId;
        
        // Get restaurant
        const restaurant = db.restaurants.getById(order.restaurantId) || { name: 'Unknown' };
        
        // Fill order details
        document.getElementById('orderNumber').textContent = order.id;
        document.getElementById('orderStatus').value = order.status || 'new';
        document.getElementById('orderCustomer').textContent = order.customerName || 'N/A';
        document.getElementById('orderPhone').textContent = order.customerPhone || 'N/A';
        document.getElementById('orderRestaurant').textContent = restaurant.name;
        document.getElementById('orderPickupTime').textContent = order.pickupTime ? `${order.pickupTime} minutes` : 'N/A';
        document.getElementById('orderDateTime').textContent = order.createdAt ? formatDateTime(order.createdAt) : 'N/A';
        
        // Fill order items
        const orderItemsContainer = document.getElementById('orderItems');
        orderItemsContainer.innerHTML = '';
        
        if (order.items && order.items.length > 0) {
          order.items.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${item.name}</td>
              <td>${item.price}₽</td>
              <td>${item.quantity}</td>
              <td>${(item.price * item.quantity).toFixed(2)}₽</td>
            `;
            orderItemsContainer.appendChild(row);
          });
        } else {
          orderItemsContainer.innerHTML = '<tr><td colspan="4" style="text-align: center;">No items</td></tr>';
        }
        
        // Set total
        document.getElementById('orderTotal').textContent = `${order.totalAmount || 0}₽`;
        
        // Open modal
        document.getElementById('orderModal').classList.add('active');
      }
      
      // Update order status
      function updateOrderStatus() {
        console.log('Updating order status for:', currentOrderId);
        if (!currentOrderId) return;
        
        const newStatus = document.getElementById('orderStatus').value;
        
        try {
          db.orders.update(currentOrderId, { status: newStatus });
          showStatusMessage('ordersStatusMessage', `Order status updated to "${newStatus}"`, 'success');
          
          // Close modal and reload orders
          document.getElementById('orderModal').classList.remove('active');
          loadOrders();
          
          // Also reload dashboard recent orders
          loadDashboardData();
        } catch (error) {
          console.error('Error updating order status:', error);
          showStatusMessage('ordersStatusMessage', `Error: ${error.message}`, 'error');
        }
      }
      
      // Load orders
      function loadOrders() {
        console.log('Loading orders');
        try {
          const restaurantFilter = document.getElementById('orderFilterRestaurant').value;
          const statusFilter = document.getElementById('orderFilterStatus').value;
          
          let orders = db.orders.getAll();
          
          // Apply filters
          if (restaurantFilter) {
            orders = orders.filter(order => order.restaurantId === restaurantFilter);
          }
          
          if (statusFilter) {
            orders = orders.filter(order => order.status === statusFilter);
          }
          
          const ordersTable = document.getElementById('ordersTable');
          ordersTable.innerHTML = '';
          
          if (orders.length === 0) {
            ordersTable.innerHTML = '<tr><td colspan="7" style="text-align: center;">No orders found</td></tr>';
            return;
          }
          
          orders.forEach(order => {
            // Get restaurant
            const restaurant = db.restaurants.getById(order.restaurantId) || { name: 'Unknown' };
            
            // Format status
            let statusClass = '';
            let statusText = order.status || 'new';
            
            switch (statusText) {
              case 'new':
                statusClass = 'status-new';
                statusText = 'New';
                break;
              case 'processing':
                statusClass = 'status-processing';
                statusText = 'Processing';
                break;
              case 'ready':
                statusClass = 'status-ready';
                statusText = 'Ready for pickup';
                break;
              case 'completed':
                statusClass = 'status-completed';
                statusText = 'Completed';
                break;
              case 'cancelled':
                statusClass = 'status-cancelled';
                statusText = 'Cancelled';
                break;
            }
            
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${order.id}</td>
              <td>${order.customerName || 'N/A'}</td>
              <td>${restaurant.name}</td>
              <td>${order.totalAmount || 0}₽</td>
              <td><span class="status-badge ${statusClass}">${statusText}</span></td>
              <td>${order.createdAt ? formatDateTime(order.createdAt) : 'N/A'}</td>
              <td class="actions">
                <button class="admin-btn" data-order-id="${order.id}" data-action="view-order">View</button>
              </td>
            `;
            
            ordersTable.appendChild(row);
          });
          
          // Add event handlers
          document.querySelectorAll('[data-action="view-order"]').forEach(btn => {
            btn.addEventListener('click', function() {
              const orderId = this.getAttribute('data-order-id');
              viewOrder(orderId);
            });
          });
        } catch (error) {
          console.error('Error loading orders:', error);
          document.getElementById('ordersTable').innerHTML = `<tr><td colspan="7" style="text-align: center;">Error: ${error.message}</td></tr>`;
        }
      }
      
      // SETTINGS FUNCTIONS
      
      // Initialize settings
      function initSettings() {
        console.log('Initializing settings');
        
        // Website settings form
        const settingsForm = document.getElementById('settingsForm');
        settingsForm.addEventListener('submit', function(e) {
          e.preventDefault();
          console.log('Submitting settings form');
          
          const settingsData = {
            siteTitle: document.getElementById('siteTitle').value,
            contactEmail: document.getElementById('contactEmail').value,
            contactPhone: document.getElementById('contactPhone').value,
            telegramBotEnabled: document.getElementById('telegramBotEnabled').checked,
            telegramBotToken: document.getElementById('telegramBotToken').value,
            telegramChatId: document.getElementById('telegramChatId').value
          };
          
          try {
            db.settings.update(settingsData);
            showStatusMessage('settingsStatusMessage', 'Website settings saved successfully', 'success');
          } catch (error) {
            console.error('Error saving settings:', error);
            showStatusMessage('settingsStatusMessage', `Error: ${error.message}`, 'error');
          }
        });
        
        // Admin credentials form
        const adminForm = document.getElementById('adminForm');
        adminForm.addEventListener('submit', function(e) {
          e.preventDefault();
          console.log('Submitting admin form');
          
          const username = document.getElementById('adminUsername').value;
          const password = document.getElementById('adminPassword').value;
          const passwordConfirm = document.getElementById('adminPasswordConfirm').value;
          
          if (!username) {
            showStatusMessage('adminStatusMessage', 'Username cannot be empty', 'error');
            return;
          }
          
          if (password !== passwordConfirm) {
            showStatusMessage('adminStatusMessage', 'Passwords do not match', 'error');
            return;
          }
          
          try {
            // If password is empty, keep the current password
            const credentials = db.auth.getCredentials();
            const newPassword = password || credentials.password;
            
            db.auth.updateCredentials(username, newPassword);
            showStatusMessage('adminStatusMessage', 'Admin credentials updated successfully', 'success');
            
            // Clear password fields
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminPasswordConfirm').value = '';
          } catch (error) {
            console.error('Error updating admin credentials:', error);
            showStatusMessage('adminStatusMessage', `Error: ${error.message}`, 'error');
          }
        });
      }
      
      // Load settings
      function loadSettings() {
        console.log('Loading settings');
        try {
          const settings = db.settings.getAll();
          
          // Fill website settings form
          document.getElementById('siteTitle').value = settings.siteTitle || 'FOOD MENU';
          document.getElementById('contactEmail').value = settings.contactEmail || 'info@foodmenu.com';
          document.getElementById('contactPhone').value = settings.contactPhone || '+7 (123) 456-78-90';
          document.getElementById('telegramBotEnabled').checked = settings.telegramBotEnabled || false;
          document.getElementById('telegramBotToken').value = settings.telegramBotToken || '';
          document.getElementById('telegramChatId').value = settings.telegramChatId || '';
          
          // Fill admin form
          const credentials = db.auth.getCredentials();
          document.getElementById('adminUsername').value = credentials.username || 'admin';
        } catch (error) {
          console.error('Error loading settings:', error);
          showStatusMessage('settingsStatusMessage', `Error: ${error.message}`, 'error');
        }
      }
      
      // DASHBOARD FUNCTIONS
      
      // Format date and time
      function formatDateTime(dateTimeString) {
        try {
          const dateTime = new Date(dateTimeString);
          return dateTime.toLocaleString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        } catch (error) {
          console.error('Error formatting date:', error);
          return dateTimeString || 'N/A';
        }
      }
      
      // Load dashboard data
      function loadDashboardData() {
        console.log('Loading dashboard data');
        try {
          // Get statistics
          const stats = db.statistics.getDashboardStats();
          
          // Update counters
          document.getElementById('restaurantCount').textContent = stats.restaurantCount || 0;
          document.getElementById('productCount').textContent = stats.productCount || 0;
          document.getElementById('totalOrders').textContent = stats.orderCount || 0;
          document.getElementById('totalRevenue').textContent = (stats.totalRevenue || 0) + '₽';
          
          // Update recent orders table
          const recentOrdersTable = document.getElementById('recentOrdersTable');
          recentOrdersTable.innerHTML = '';
          
          if (stats.recentOrders && stats.recentOrders.length > 0) {
            stats.recentOrders.forEach(order => {
              // Get restaurant
              const restaurant = db.restaurants.getById(order.restaurantId) || { name: 'Unknown' };
              
              // Format status
              let statusClass = '';
              let statusText = order.status || 'new';
              
              switch (statusText) {
                case 'new':
                  statusClass = 'status-new';
                  statusText = 'New';
                  break;
                case 'processing':
                  statusClass = 'status-processing';
                  statusText = 'Processing';
                  break;
                case 'ready':
                  statusClass = 'status-ready';
                  statusText = 'Ready for pickup';
                  break;
                case 'completed':
                  statusClass = 'status-completed';
                  statusText = 'Completed';
                  break;
                case 'cancelled':
                  statusClass = 'status-cancelled';
                  statusText = 'Cancelled';
                  break;
              }
              
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${order.id}</td>
                <td>${order.customerName || 'N/A'}</td>
                <td>${restaurant.name}</td>
                <td>${order.totalAmount || 0}₽</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td>${order.createdAt ? formatDateTime(order.createdAt) : 'N/A'}</td>
              `;
              
              recentOrdersTable.appendChild(row);
            });
          } else {
            recentOrdersTable.innerHTML = '<tr><td colspan="6" style="text-align: center;">No recent orders</td></tr>';
          }
        } catch (error) {
          console.error('Error loading dashboard data:', error);
          document.getElementById('recentOrdersTable').innerHTML = `<tr><td colspan="6" style="text-align: center;">Error: ${error.message}</td></tr>`;
        }
      }
      
      // HELPER FUNCTIONS
      
      // Show status message
      function showStatusMessage(elementId, message, type = 'success') {
        const statusMessage = document.getElementById(elementId);
        if (!statusMessage) return;
        
        statusMessage.textContent = message;
        statusMessage.className = `status-message ${type}`;
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
          statusMessage.className = 'status-message';
        }, 5000);
      }
      
      // Initialize all components
      function init() {
        console.log('Initializing admin panel');
        
        // Initialize tabs
        initTabs();
        
        // Initialize forms
        initRestaurantForm();
        initProductForm();
        initCategoryForm();
        initOrderFilters();
        initSettings();
        
        // Event listeners for order modal
        document.getElementById('closeOrderModal').addEventListener('click', function() {
          document.getElementById('orderModal').classList.remove('active');
        });
        
        document.getElementById('closeOrderBtn').addEventListener('click', function() {
          document.getElementById('orderModal').classList.remove('active');
        });
        
        document.getElementById('saveOrderStatusBtn').addEventListener('click', updateOrderStatus);
        
        // Load dashboard data initially
        loadDashboardData();
      }
      
      // Call init
      init();
    });
  </script>
</body>
</html>
                  statusText = 'Ready for pickup';
